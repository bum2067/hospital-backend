<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hospital.schedule.mapper.ShiftMapper">

    <!-- ===========================================================
         ðŸ§© ResultMap: DB ê²°ê³¼ë¥¼ ShiftDtoë¡œ ë§¤í•‘
    ============================================================ -->
    <resultMap id="ShiftResult" type="com.hospital.schedule.dtos.ShiftDto">
        <id property="id" column="id"/>
        <result property="employeeId" column="employee_id"/>
        <result property="shiftTypeId" column="shift_type_id"/>
        <result property="workDate" column="work_date"/>
        <result property="employeeName" column="employee_name"/>
        <result property="shiftTypeName" column="shift_type_name"/>
    </resultMap>

    <!-- ===========================================================
         1ï¸âƒ£ ëª¨ë“  ê·¼ë¬´ ì¡°íšŒ
    ============================================================ -->
    <select id="findAll" resultMap="ShiftResult">
        SELECT s.id,
               s.employee_id,
               s.shift_type_id,
               s.work_date,
               e.name AS employee_name,
               t.name AS shift_type_name
        FROM shift s
                 JOIN employee e ON s.employee_id = e.id
                 JOIN shift_type t ON s.shift_type_id = t.id
        ORDER BY s.work_date ASC, e.id ASC
    </select>

    <!-- ===========================================================
         2ï¸âƒ£ ì§ì›ë³„ ê·¼ë¬´ ì¡°íšŒ
    ============================================================ -->
    <select id="findByEmployee" resultMap="ShiftResult" parameterType="long">
        SELECT s.id,
               s.employee_id,
               s.shift_type_id,
               s.work_date,
               e.name AS employee_name,
               t.name AS shift_type_name
        FROM shift s
                 JOIN employee e ON s.employee_id = e.id
                 JOIN shift_type t ON s.shift_type_id = t.id
        WHERE s.employee_id = #{employeeId}
        ORDER BY s.work_date ASC
    </select>

    <!-- ===========================================================
         3ï¸âƒ£ ê·¼ë¬´ ë“±ë¡
         â€» Simulated Annealing ê²°ê³¼ ì‚½ìž…ìš©
         â€» ì¤‘ë³µ ë°ì´í„°ê°€ ë“¤ì–´ì˜¤ë©´ ë®ì–´ì”Œì›€ (ì˜µì…˜)
    ============================================================ -->
    <insert id="insert" parameterType="com.hospital.schedule.dtos.ShiftRequestDto">
        INSERT INTO shift (employee_id, shift_type_id, work_date)
        VALUES (#{employeeId}, #{shiftTypeId}, #{workDate})
        ON DUPLICATE KEY UPDATE
            shift_type_id = VALUES(shift_type_id),
            work_date = VALUES(work_date)
    </insert>

    <!-- ===========================================================
         4ï¸âƒ£ ê°œë³„ ê·¼ë¬´ ì‚­ì œ (ID ê¸°ì¤€)
    ============================================================ -->
    <delete id="delete" parameterType="long">
        DELETE FROM shift WHERE id = #{id}
    </delete>

    <!-- ===========================================================
         5ï¸âƒ£ íŠ¹ì • ê¸°ê°„ + ê·¼ë¬´ìœ í˜• ì‚­ì œ (ì„ íƒ)
         â€» ë‹¨ê¸° í…ŒìŠ¤íŠ¸ìš© or êµ¬ê°„ ì´ˆê¸°í™”ìš©
    ============================================================ -->
    <delete id="deleteByRangeAndType">
        DELETE FROM shift
        WHERE work_date BETWEEN #{start} AND #{end}
          AND shift_type_id = #{shiftTypeId}
    </delete>

    <!-- ===========================================================
         6ï¸âƒ£ ì—°ë„ + ì›” ë‹¨ìœ„ ì „ì²´ ì‚­ì œ
         â€» ìƒˆ ìŠ¤ì¼€ì¤„ ìƒì„± ì‹œ ê¸°ì¡´ ê·¼ë¬´í‘œ ë®ì–´ì“°ê¸°ìš©
         â€» SchedulingService.generateMonthlySchedule() ì—ì„œ ì‚¬ìš©
    ============================================================ -->
    <delete id="deleteByMonth" parameterType="map">
        DELETE FROM shift
        WHERE YEAR(work_date) = #{year}
          AND MONTH(work_date) = #{month}
    </delete>
    
    <!-- ì˜¤ëŠ˜ ê·¼ë¬´ íƒ€ìž… ì¡°íšŒ -->
	<select id="findShift" resultType="long">
    SELECT shift_type_id
    FROM shift
    WHERE employee_id = #{employeeId}
      AND work_date = #{date}
	</select>

	<!-- ê·¼ë¬´ ìˆ˜ì • -->
	<update id="updateShift">
    UPDATE shift
    SET shift_type_id = #{shiftTypeId}
    WHERE employee_id = #{employeeId}
      AND work_date = #{date}
	</update>


</mapper>
